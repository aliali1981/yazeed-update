<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام مدرسة يزيد بن الحارث | المطور</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

    <style>
        :root { 
            --primary: #004a99; 
            --secondary: #28a745; 
            --bg: #f0f4f8; 
            --error: #dc3545;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 10px; 
            text-align: right; 
            position: relative;
            min-height: 100vh;
        }

        body::before {
            content: ""; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 400px; height: 400px; background-image: url('logo.png');
            background-repeat: no-repeat; background-position: center; background-size: contain;
            opacity: 0.05; z-index: -1; pointer-events: none;
        }

        .container { 
            max-width: 850px; margin: 20px auto; 
            background: rgba(255, 255, 255, 0.95); padding: 30px; 
            border-radius: 25px; box-shadow: 0 15px 50px rgba(0,0,0,0.1); 
            border-top: 10px solid var(--primary); backdrop-filter: blur(5px);
        }

        .header-logos { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .logo { width: 85px; height: auto; z-index: 2; }

        .class-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin: 20px 0; }
        .class-card { 
            background: #fff; border: 2px solid #edf2f7; padding: 18px 10px; 
            border-radius: 15px; text-align: center; cursor: pointer; 
            transition: 0.3s; font-weight: 700; color: #4a5568;
        }
        .class-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .class-card.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 10px 20px rgba(0,74,153,0.2); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #eee; text-align: center; }
        .progress-bar { width: 100%; background: #eee; height: 8px; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .progress-fill { background: var(--secondary); height: 100%; border-radius: 4px; transition: width 0.5s; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th { background: var(--primary); color: white; padding: 12px; font-size: 14px; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 13px; }

        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 10px; font-weight: 700; color: var(--primary); }
        select, input { width: 100%; padding: 15px; border: 2px solid #edf2f7; border-radius: 12px; font-family: 'Cairo'; box-sizing: border-box; }

        .btn-submit { 
            width: 100%; padding: 18px; background: linear-gradient(135deg, var(--secondary) 0%, #218838 100%); 
            color: white; border: none; border-radius: 15px; font-weight: 700; cursor: pointer; 
        }

        .school-footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; }
        .manager-name { color: var(--primary); font-size: 20px; font-weight: 700; cursor: pointer; user-select: none; }

        #successModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 400px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container" id="userView">
    <div class="header-logos">
        <img src="وزارة التعليم.png" alt="وزارة التعليم" class="logo">
        <img src="logo.png" alt="شعار المدرسة" class="logo">
    </div>

    <div style="text-align: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary); margin: 0;">مدرسة يزيد بن الحارث (5-8)</h2>
        <p style="color: #666; font-size: 14px;">استمارة تحديث أرقام هواتف أولياء الأمور</p>
    </div>

    <form id="updateForm">
        <label>1. اختر الصف الدراسي:</label>
        <div class="class-grid" id="classPicker"></div>

        <input type="hidden" id="classInput" required>
        <input type="hidden" id="classNameInput">

        <div id="nextSteps" class="hidden">
            <div class="form-group">
                <label>2. اسم الطالب الثلاثي والقبيلة:</label>
                <select id="studentSelect" required></select>
            </div>
            <div class="form-group">
                <label>3. صلة القرابة:</label>
                <select id="relation">
                    <option>الأب</option><option>الأم</option><option>ولي الأمر</option>
                </select>
            </div>
            <div class="form-group">
                <label>4. رقم الهاتف (8 أرقام):</label>
                <input type="tel" id="newPhone" placeholder="9xxxxxxx" maxlength="8" required>
            </div>
            <button type="submit" class="btn-submit" id="submitBtn">إرسال التحديث الآن</button>
        </div>
    </form>

    <div class="school-footer" id="secretTrigger" onclick="handleSecretClick()">
        <div style="color: #888; font-size: 13px;">تحت إشراف مدير المدرسة</div>
        <div class="manager-name">الأستاذ هشام الكحالي</div>
    </div>
</div>

<div class="container hidden" id="adminView">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
        <h2 style="color: var(--primary); margin:0;">لوحة التحكم المركزية</h2>
        <button onclick="location.reload()" style="background:#eee; border:none; padding:5px 15px; border-radius:8px; cursor:pointer;">خروج</button>
    </div>
    <div class="stats-grid" id="statsArea"></div>
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="adminSearch" placeholder="ابحث عن اسم طالب..." onkeyup="filterAdminTable()">
        <button onclick="exportToExcel()" style="background: var(--secondary); color: white; border: none; padding: 0 20px; border-radius: 12px; cursor: pointer;">Excel</button>
    </div>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr><th>التاريخ</th><th>الصف</th><th>الطالب</th><th>الهاتف</th><th>الصلة</th></tr>
            </thead>
            <tbody id="adminTableBody"></tbody>
        </table>
    </div>
</div>

<div id="successModal">
    <div class="modal-content">
        <div style="font-size: 60px; color: var(--secondary);">✔</div>
        <h2 style="color: var(--primary);">تم الاستلام بنجاح</h2>
        <button onclick="location.reload()" class="btn-submit">عودة للرئيسية</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBQsjvkdmYaR6OOGAbG-WdqIJCiHbw_Avo",
        authDomain: "madrassa-yazeed.firebaseapp.com",
        projectId: "madrassa-yazeed",
        storageBucket: "madrassa-yazeed.firebasestorage.app",
        messagingSenderId: "1025900552589",
        appId: "1:1025900552589:web:1634648a6b6a8b4b05ddc4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const classes = {
        "5_1": {name: "الخامس أول", total: 20}, "5_2": {name: "الخامس ثاني", total: 22}, "5_3": {name: "الخامس ثالث", total: 16},
        "6_1": {name: "السادس أول", total: 27}, "6_2": {name: "السادس ثاني", total: 27},
        "7_1": {name: "السابع أول", total: 25}, "7_2": {name: "السابع ثاني", total: 27}, "7_3": {name: "السابع ثالث", total: 26},
        "8_1": {name: "الثامن أول", total: 32}, "8_2": {name: "الثامن ثاني", total: 30}
    };

    const studentsData = {
        "5_1": ["أحمد بن سالم بن سعيد حسن خوار", "الأمين محمد أحمد الطيب", "تركي بن محمد بن سعيد مسلم مسن", "خالد بن راشد بن سعيد سالم مسن", "سالم بن محمد بن سالم صالح جداد", "سالم بن مسلم بن سهيل محمد الراشدي", "سعود بن سالم بن ظويهر سالم جداد", "سعود بن شهاب بن نافع مسلم المسهلي الكثيري", "سعيد بن عبدالله بن بقال خويدع خوار", "سلطان بن محمد بن علي مهوي العامري", "عامر بن سهيل بن عامر سليّم قمصيت", "عبدالرحمن أحمد فوزي عبدالفتاح", "علي بن سعد بن مسلم سعيد الراشدي", "عوض بن محمد بن عوض خادم الوهيبي", "غانم بن محمد بن سليم مسلم الجنيبي", "غانم بن محمد بن مبارك بخيت جداد", "محمد أحمد محمود عبدالحميد", "محمد بن مسلم بن محمد بخيت مسن", "نايف بن محمد بن سالم سهيل مسن", "همدان بن أحمد بن عبدالله محمد جداد"],
        "5_2": ["أحمد بن سعيد بن مسلم أحمد جداد", "أمجد بن سعيد بن خميس سعيد الشكيلي", "البراء أحمد سميح علي سيد", "خالد بن أحمد بن مسلم محمد مسن", "خالد بن محمد بن مسلم سنكور خوار", "سالم بن حمد بن مبخوت حماده جداد", "سالم بن عوض بن سالم محمد مسن", "سالم بن نايف بن سالم عيضه جداد", "سعيد بن بخيت بن عبدي بخيت خوار", "سعيد بن خالد بن بخيت زايد مسن", "سعيد بن صالح بن سهيل علي بيت جداد", "سلمان بن ناجي بن سالم سعد خوار", "سهيل بن معمر بن سهيل مسلم جداد الكثيري", "صالح يحيى مسلم", "صقر بن محمد بن العبد سهيل جداد", "عبدالرحمن سامي محمد أحمد يوسف المزين", "محمد بن بخيت بن أحمد محمد مسن", "محمد بن سالم بن سهيل مطر جداد", "محمد بن عامر بن محمد أحمد المسهلي", "محمد بن غازي بن كفيش جعيد جداد الكثيري", "محمد بن فهد بن سالم خويتم مسن", "مسلم بن بخيت بن عبدي بخيت خوار"],
        "5_3": ["إلياس بن ابراهيم بن حمد مسعود العامري", "تيمور بن أحمد بن مبروك أحمد مسن", "خالد أحمد حسن التابعي", "خالد بن عمرو بن غفيل سالم خوار", "سامي بن عماد الميساوي", "شهاب بن حمد بن محمد حمد الهنائي", "عبدالله بن محمد بن عيظه سعيد جداد الكثيري", "فهد بن محمد بن سالم مسلم المسهلي", "فيصل بن حمد بن محمد حمد الهنائي", "مازن مصطفى محمد أحمد على", "محمد بن حسين بن سالم مبخوت خوار", "محمد بن سعيد بن سالم خويتم مسن", "مروان سلامه حسين علي شليل", "مسلم بن سعيد بن سعد سعيد جداد", "مسلم بن محمد بن مسلم أحمد جداد", "هيثم بن فواز بن سليمان عبدالله الهاشمي"],
        "6_1": ["الخطاب محمد حمد النيل أحمد", "الخليل بن غسان بن طالب بدر الصمصامي", "الهجرس بن سليمان بن مبارك سليمان الحبسي", "أنس محمود محمد أحمد", "أواب عبدالعظيم حسين الطاهر", "حسين محمد يوسف خضر", "سالم بن ثاني بن محمد بخيت خوار", "سالم بن حمود بن سالم سعيد الوائلي", "سالم بن محمد بن سالم عبدالله الراشدي", "سعود بن عبدالعزيز بن بخيت حم مسن", "سعيد بن حاتم بن سعيد محمد بيت مسن", "سعيد بن مسلم بن سعيد سهيل مسن", "سهيل بن سليم بن سهيل سليم قمصيت", "سهيل محسن سهيل ال خوار", "سيف بن خميس بن سالم محمد الجنيبي", "سيف بن نائف بن عبدالله مبارك جداد", "عبد الرحمن بن محمد بن سعيد سالم مسن", "عبدالله بن غانم بن سالم عبدالله الراشدي", "عبدالله بن محمد بن أحمد رويكان خوار", "عبدالله عواض عبدالله عبداللطيف", "علي بن حامد بن مسلم محمد مسن الكثيري", "علي بن سعيد بن محمد سالم خوار", "مبروك بن محمد بن سالم ظويهر جداد", "متعب بن سعيد بن عبدالله محمد جداد", "محمد بن جميل بن عبدي بخيت خوار", "مسلم بن بدر بن مسلم سعيد مسن", "مسلم بن محمد بن مسلم سعيد جداد"],
        "6_2": ["الليث بن إبراهيم بن ناصر علي الحوسني", "المغيره بشرى محجوب أحمد", "بخيت بن سعيد بن مبارك بخيت جداد", "سالم بن أحمد بن سهيل سالم خوار", "سالم بن حاتم بن سالم سعد خوار", "سالم بن سلطان بن سليّم غانم الراشدي", "سالم بن سهيل بن سالم المحناء جداد", "سعد بن كرامه بن سالم علي خوار", "سعيد بن عادل بن سالم خويتم مسن بيت كثير", "سلطان بن مسلم بن سلطان أسد الراشدي", "عامر بن خالد بن سالم مسن", "عبدالله بن حسين بن علي محمد ال عبدالسلام", "عبدالله بن عبدي بن بخيت زولة خوار", "عبدالله سعيدان سيعد الراشدي", "غازي بن محمد بن صالح أحمد جداد", "غيث بن أحمد بن بخيت معيوف المسهلي", "مازن تامر محمد محمد علوش", "مازن عبدالسميع سليمان خميس", "ماهر بن محمد بن مستهيل محمد صفرار", "محمد بن عبدالله بن محمد عبدالله خوار", "محمد حافظ سعيد رعفيت", "محمد محسن سهيل ال خوال", "مدرك بن خالد بن سعيد بخيت الشعشعي", "مسلم بن سالم بن عبدالله سعيد الراشدي", "مسلم بن محمد بن سعيد مسلم جداد", "يوسف بن محمد بن بخيت سالم خوار", "يوسف عماد الميساوي"],
        "7_1": ["أحمد أمجد أحمد أحمد نجاد", "أحمد بن سعيد بن صالح أحمد جداد", "العبد بن محمد بن العبد زائد مسن", "النابي بن محمد بن سالم سهيل مسن", "بخيت بن أحمد بن بخيت فريح مسن الكثيري", "تميم بن محمد بن سهيل جديد جداد الكثيري", "تميم بن محمد بن مبروك عبدالله المسهلي", "حمد بن محمد بن أحمد الهزار الكثيري", "حمد بن محمد بن سعيد مسن", "راشد بن محمد بن أحمد محمد مسن الكثيري", "سالم بن سعد بن صلاح رعفيت", "سعيد بن شهاب بن أحمد محمد مسن", "سعيد بن محمد بن صالح جداد", "سعيد بن محمد بن مبارك بخيت جداد", "سلطان بن حمزة بن مسلم نفل ربعات الكثيري", "عامر بن محمد بن مسلم بخيت المسهلي", "عبدالله بن سالم بن سهيل سليم قمصيت", "عمر أحمد محمد أحمد", "عمر عبدالقوى ابراهيم ابراهيم", "فريح بن عبدالله بن فريح أحمد مسن", "مجتبى عيسى محمد", "مسلم بن محمد بن عوض خادم الوهيبي", "نصر بن سالم بن ظويهر سالم جداد", "ياسر بن عادل بن سالم مسن بيت كثير", "يوسف عمر أحمد عبد الرحمن حاكم"],
        "7_2": ["ابراهيم محمد سالم السطري", "العباس بن مبخوت بن سالم مسن بيت كثير", "المنذر بن فواز بن سليمان عبدالله الهاشمي", "امير بن ناصر بن عبدالرحمن عبدالله البلوشي", "حسين سلامه حسين علي شليل", "خالد بن سالم بن علي عبدالله العلوي", "خالد بن محمد بن سهيل مطر جداد", "خالد بن مسلم بن أحمد جداد", "رويزم بن مسلم بن بخيت رويزم صندل المحرمي", "سالم بن مبارك بن سهيل محمد الراشدي", "سعد بن محمد بن سعد حفيظ خوار", "سعود بن عبدالله بن بخيت زايد مسن", "سعيد بن عبدالله بن سالم أحمد جداد", "سعيد بن مسلم بن عبدالله سعيد جداد", "سلطان بن مسلم بن سالم صالح جداد", "عبدالله بن عارف بن سالم جداد", "علي بن سعيد بن علي خوار", "عمر فؤاد فهمي محمد فؤاد", "فهد بن غانم بن سالم جداد", "محسن معتصم محمد الامام", "محمد بن سالم بن مبخوت محمد الراشدي", "مسلم بن سالم بن سهيل الراشدي", "مصطفى محمود كريم ابراهيم أحمد", "معاذ أحمد سميح علي سيد", "منيف بن سعيد بن محمد سالم جداد", "هادف بن سعيد بن هادف حسن شحري خوار", "وائل بن حمود بن سالم سعيد الوائلي"],
        "7_3": ["أحمد بن نائف بن عبدالله محمد جداد", "الطلح بن سالم بن حسن علي خوار", "بخيت بن مسلم سالم مبخوت الراشدي", "بدر بن عامر بن مسلم الرحابه جداد", "حثيث بن سلطان بن محمد سهيل مسن", "حمد بن محمد بن عبدالله محمد جداد الكثيري", "سالم بن أحمد بن سالم جداد", "سعيد بن مبروك بن سالم عامر المسهلي", "سهيل بن عبدالله بن سهيل حافظ خوار", "عبد الله أمير عبدالله نصر", "عبدالله بن محمد بن علي مهوي العامري", "علي بن ثاني بن علي سالم جداد بيت كثير", "فارس زياد محمد أبو رواع", "مبارك بن سعيد بن سالم خويتم مسن", "محسن بن عقيل بن سالم سعد خوار", "محمد بن بخيت بن فرج السنح شهوان المهري", "محمد بن علي بن بخيت محمد الراشدي", "محمد بن غانم بن الرضه سلاوم جداد", "محمد بن مسلم بن محمد مسلم جداد", "محمد بن ناصر بن عبدالله جداد", "محمد بن هيثم بن سالم فائل جداد الكثيري", "مسلم بن حسن بن هادف حسن شحري خوار", "معاذ فؤاد الحنيش الأحمد", "ناصر بن علي بن ناصر سهيل جداد", "نور الدين محسن العلي", "هيثم بن محمد بن سالم فائل جداد"],
        "8_1": ["أحمد بن سعيد بن بخيت صندل المحرمي", "أحمد بن عامر بن محمد سالم خوار", "أحمد بن محمد بن سالم مبارك المسهلي", "المر بن غانم بن محمد سهيل المسهلي الكثيري", "إياد أحمد توفيق عباس مصطفى", "بخيت بن خالد بن بخيت زايد مسن", "بخيت بن سعيدان بن بخيت رويزم صندل المحرمي", "حاكم بن فهد بن سالم خويتم مسن", "حريز بن محسن بن صالح حريز خوار", "حمد بن محمد بن العبد سهيل جداد", "حمد بن محمد بن سعد سعيد جداد", "حمدان بن محمد بن عبدالله محمد جداد", "زايد بن محمد بن مسلم سعيد جداد", "سعود بن أحمد بن محمد الطوف الهزار الكثيري", "سعود بن حاتم بن سعيد محمد بيت مسن", "سعود بن محمد بن صالح أحمد جداد", "سعيد بن عبدالله بن مبخوت حماده جداد", "سهيل بن صالح بن بخيت صالح منيف خوار", "سهيل بن محسن بن سليم محفوظ خوار", "سهيل بن محمد بن سالم علي الحمر", "سيف بن عبدالله بن مسلم محمد مسن الكثيري", "فائل بن محمد بن فائل مطر جداد", "محمد اسماعيل آدم علي", "محمد بن سالم بن سعيد المحناء جداد", "محمد بن سعد بن مسلم سعيد الراشدي", "محمد بن مسلم بن سعيد بخيت مسن", "محمد بن مسلم بن سهيل مطر جداد", "محمد مصطفى عبدالنبي عبده", "مسلم بن حمد بن سلوم مسلم الجنيبي", "مطر بن علي بن سالم عامر المسهلي", "ناصر بن سالم بن محمد الطوف الكثيري", "صالح جعفر صالح عبد الله"],
        "8_2": ["الجلندى بن يقظان بن سليمان سالم الناصري", "الخطاب محمد صلاح محمود", "تميم بن هيثم بن أحمد سعيد مسن الكثيري", "خالد بن محمد بن سالم أحمد جداد", "خالد بن نايف بن سالم عيضه جداد", "ركاض بن بخيت بن فرج شهوان عزاب", "سالم بن حامد بن مسلم محمد مسن الكثيري", "سالم بن عامر بن سالم ظويهر جداد", "سالم سهيل سالم فرج الخوار", "سعد بن حاكم بن أحمد خوار", "سعود بن سالم بن سعيد سهيل مسن", "سعود بن نائف بن عبدالله محمد جداد", "سعيد بن راكان بن مسلم محمد مسن الكثيري", "صالح بن علي بن صالح علي المسهلي", "طارق أحمد ضاحي عبدالغني حسين", "طلال بن مسلم بن سعيد سهيل مسن", "عامر بن أحمد بن مبخوت مسلم منيف خوار", "عبدالعزيز بن فيصل بن سعيد محمد المسهلي", "عبدالله بن سالم بن أحمد صالح مسن", "علي جمعان سالم سعيد موسى", "عمر بن محمد بن سليمان محمد الفهدي", "غفيل بن عمرو بن غفيل سالم خوار", "مالك وليد محمد فؤاد", "محمد بن سعيد بن صالح أحمد جداد", "محمد بن مسلم بن سهيل محمد الراشدي", "مسلم بن أحمد بن مسلم الرحابه جداد", "ناصر بن مرشد بن بخيت عبدالله مسن", "يام بن محمد بن سالم بخيت الكثيري", "يوسف بن سالم بن عامر سلاوم جداد", "محمد حسين العلي"]
    };

    const picker = document.getElementById('classPicker');
    for(let key in classes) {
        let div = document.createElement('div');
        div.className = 'class-card';
        div.innerText = classes[key].name;
        div.onclick = function() { selectClass(this, key, classes[key].name); };
        picker.appendChild(div);
    }

    function selectClass(el, code, name) {
        document.querySelectorAll('.class-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('classInput').value = code;
        document.getElementById('classNameInput').value = name;
        const sel = document.getElementById('studentSelect');
        sel.innerHTML = '<option value="" disabled selected>-- اختر الطالب من القائمة --</option>';
        studentsData[code].forEach(s => {
            let o = document.createElement('option'); o.value = s; o.innerText = s; sel.appendChild(o);
        });
        document.getElementById('nextSteps').classList.remove('hidden');
    }

    document.getElementById('updateForm').onsubmit = async (e) => {
        e.preventDefault();
        const phone = document.getElementById('newPhone').value;
        if(!/^[79][0-9]{7}$/.test(phone)) return alert("رقم الهاتف غير صحيح");
        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerText = "جاري الحفظ...";
        try {
            await db.collection("updates").add({
                classCode: document.getElementById('classInput').value,
                className: document.getElementById('classNameInput').value,
                studentName: document.getElementById('studentSelect').value,
                phoneNumber: phone,
                relation: document.getElementById('relation').value,
                timestamp: new Date().toLocaleString('ar-OM')
            });
            document.getElementById('successModal').style.display = 'flex';
        } catch(e) { alert("فشل الاتصال"); btn.disabled = false; }
    };

    let clickCount = 0;
    function handleSecretClick() {
        clickCount++;
        if(clickCount === 3) {
            clickCount = 0;
            if(prompt("دخول المدير - كلمة المرور:") === "Yazeed2026") {
                document.getElementById('userView').classList.add('hidden');
                document.getElementById('adminView').classList.remove('hidden');
                loadAdminDashboard();
            }
        }
        setTimeout(() => clickCount = 0, 1000);
    }

    let allData = [];
    function loadAdminDashboard() {
        db.collection("updates").orderBy("timestamp", "desc").onSnapshot(snap => {
            const body = document.getElementById('adminTableBody');
            const statsArea = document.getElementById('statsArea');
            const counts = {};
            body.innerHTML = ""; allData = [];
            snap.forEach(doc => {
                const d = doc.data(); allData.push(d);
                counts[d.classCode] = (counts[d.classCode] || 0) + 1;
                body.innerHTML += `<tr><td>${d.timestamp}</td><td>${d.className}</td><td>${d.studentName}</td><td>${d.phoneNumber}</td><td>${d.relation}</td></tr>`;
            });
            statsArea.innerHTML = "";
            for(let key in classes) {
                let done = counts[key] || 0;
                let pc = Math.round((done/classes[key].total)*100);
                statsArea.innerHTML += `<div class="stat-card"><div style="font-size:12px; font-weight:bold;">${classes[key].name}</div><div style="font-size:11px;">${done} / ${classes[key].total}</div><div class="progress-bar"><div class="progress-fill" style="width:${pc}%"></div></div></div>`;
            }
        });
    }

    function filterAdminTable() {
        let q = document.getElementById('adminSearch').value.toLowerCase();
        let rows = document.getElementById('adminTableBody').rows;
        for(let r of rows) r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(allData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Updates");
        XLSX.writeFile(wb, "Yazeed_School_Data.xlsx");
    }
</script>
</body>
</html>
